#!/bin/bash

# Post-commit hook: Update cache-busting version numbers after each commit

# Generate new version number (current timestamp)
NEW_VERSION=$(date +%s)

# Get the repository root directory
REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null)

# If we can't get repo root, exit silently
if [ -z "$REPO_ROOT" ]; then
  exit 0
fi

# Change to repository root
cd "$REPO_ROOT" || exit 0

# Update all HTML files with new version (suppress errors)
sed -i '' "s/styles\.css?v=[0-9]*/styles.css?v=$NEW_VERSION/g" *.html 2>/dev/null
sed -i '' "s/content\.js?v=[0-9]*/content.js?v=$NEW_VERSION/g" *.html 2>/dev/null

# Stage the version changes
git add *.html 2>/dev/null

# Amend the commit to include version updates (silent)
git commit --amend --no-edit --no-verify 2>/dev/null

echo "âœ“ Cache-busting version updated to: $NEW_VERSION"
